name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-release:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-amd64
          - os: macos-latest
            platform: macos-universal
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf \
            | sh -s -- -y --default-toolchain=$(cat lean-toolchain)
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Fetch mathlib cache
        run: |
          lake update
          lake exe cache get

      - name: Build veribiota
        run: lake build veribiota

      - name: Package release bundle (binary + schemas + manifest)
        run: |
          mkdir -p dist
          bundle="veribiota-${{ github.ref_name }}-${{ matrix.platform }}"
          mkdir -p "dist/$bundle/profiles"
          mkdir -p "dist/$bundle/.github/scripts"
          cp .lake/build/bin/veribiota "dist/$bundle/veribiota.bin"
          cat > "dist/$bundle/veribiota" <<EOF
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
          export VERIBIOTA_VERSION="\${VERIBIOTA_VERSION:-${{ github.ref_name }}}"
          export VERIBIOTA_BUILD_ID="\${VERIBIOTA_BUILD_ID:-${{ github.sha }}}"
          export VERIBIOTA_DATA_DIR="\${VERIBIOTA_DATA_DIR:-\$DIR}"
          exec "\$DIR/veribiota.bin" "\$@"
          EOF
          chmod +x "dist/$bundle/veribiota" "dist/$bundle/veribiota.bin"
          cp -r schemas "dist/$bundle/schemas"
          cp profiles/manifest.json "dist/$bundle/profiles/manifest.json"
          cp .github/scripts/validate_snapshots.py "dist/$bundle/.github/scripts/validate_snapshots.py"
          cp LICENSE "dist/$bundle/LICENSE"
          cp NOTICE "dist/$bundle/NOTICE"
          tar -czf "dist/$bundle.tar.gz" -C dist "$bundle"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/veribiota-${{ github.ref_name }}-${{ matrix.platform }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
